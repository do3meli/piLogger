#!/bin/bash

this_dir=$(cd `dirname $0`; pwd)
this_script=$(basename $0)

. $this_dir/functions
. $this_dir/functions-sqlite3

#--------------------------------
# usage()
#--------------------------------
usage(){
cat<<EOT

Usage:

  $this_script --db                 - Get device ID's from the database 
  $this_script capture.NAME.conf    - Get device ID's from a config file

EOT
}

#================================
# MAIN
#================================
[ -z "$1" ] && { usage ; exit 1 ; }

  case $1 in
    --db)
      aliases=$(dbGetAllLocalDeviceIds)
      compositeDevices="$(dbGetAllCompositeDevices)"
      ;;
    *)
      curConfigFile=$1
      [ ! -f $curConfigFile ] && errorExit "Could not find config file: $curConfigFile"

      aliases="$(cat $curConfigFile | grep -v "^#")"
      ;;
  esac

  #--- local devices
  [ -z "$parallelProcessing" ] && parallelProcessing=1
    
  for dev in $aliases
  do
  	
  	dev_metric=$(dbGetAllMetricsForDeviceID $dev)
  	
  	for metric in $dev_metric
  	do
  	
  		#$this_dir/logMetric $dev $metric
  		echo $metric | xargs -n 1 -P${parallelProcessing}  $this_dir/logMetric $dev 

  	done
  	
  done
  
  for compositeDevice in $compositeDevices
  do
    curTemp=$($this_dir/getComposite $compositeDevice)
    $this_dir/logTemperature $compositeDevice $curTemp
  done
