#!/bin/bash

this_dir=$(cd `dirname $0`; pwd)
this_script=$(basename $0)
spoolDir=/var/spool/piLogger

. $this_dir/functions
. $this_dir/functions-sqlite3

#--------------------------------
# usage()
#--------------------------------
usage(){
cat<<EOT

Usage:

  $this_script --db                 - Get device ID's from the database 
  $this_script capture.NAME.conf    - Get device ID's from a config file

EOT
}

#================================
# MAIN
#================================
[ -z "$1" ] && { usage ; exit 1 ; }

  case $1 in
    --db)
      aliases=$(dbGetAllLocalDeviceIds)
      compositeDevices="$(dbGetAllCompositeDevices)"
      ;;
    *)
      curConfigFile=$1
      [ ! -f $curConfigFile ] && errorExit "Could not find config file: $curConfigFile"

      aliases="$(cat $curConfigFile | grep -v "^#")"
      ;;
  esac



  # if we have any files in the spool directory we have to call the corresponding function to clear it
  [ $(ls -A $spoolDir | wc -l) -gt 0 ] && { echo "$spoolDir is not Empty"; callSpoolerFunctions; } || echo "$spoolDir is empty - no need to call corresponding functions"

  # log temperature for all local devices
  [ -z "$parallelProcessing" ] && parallelProcessing=1
  echo $aliases | xargs -n 1 -P${parallelProcessing}  $this_dir/logTemperature 
  
  # process all compositeDevices
  for compositeDevice in $compositeDevices
  do
    curTemp=$($this_dir/getComposite $compositeDevice)
    $this_dir/logTemperature $compositeDevice $curTemp
  done
  
