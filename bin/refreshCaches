#!/bin/bash 

this_dir=$(cd `dirname $0`;pwd)
this_script=$(basename $0)
. $this_dir/functions
. $this_dir/functions-sqlite3

logIt "  - Refreshing caches $1"

tmpFile=$(mktemp -u -t ${this_script}.XXXXXX)

[ -z "$1" ] && {
  #--- generating all caches

  #--- default
  logIt "  - Refreshing sensorData.json"
  $htmlDir/api/sensorData --genCache  > $tmpFile
  mv $tmpFile $cacheDir/sensorData.json
  chmod 666 $cacheDir/sensorData.json 

  #--- recursively call this script again
  for time in 12h 24h 168h
  do
     $this_dir/$this_script $time
  done

  #--- sensors
  #--- recursively call this script again
    $this_dir/$this_script sensors

  exit
}

case $1 in
  *h)
    deviceGroups=$(dbGetAllPlotGroups)
    for deviceGroup in $deviceGroups
    do
      logIt "  - Refreshing sensorData.$deviceGroup.${1}.cache"
      $htmlDir/api/sensorData --genCache ${1} $deviceGroup > $tmpFile
      mv $tmpFile $cacheDir/sensorData.$deviceGroup.${1}.json
      chmod 666 $cacheDir/sensorData.$deviceGroup.${1}.json 
    done
    ;;
  sensors)
    logIt "  - Refreshing sensorAllInfo.json"
    $htmlDir/api/sensor all info > $tmpFile
    mv $tmpFile $cacheDir/sensorAllInfo.json
    chmod 666 $cacheDir/sensorAllInfo.json 
    ;;

esac    


