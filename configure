#!/bin/bash

this_dir=$(cd `dirname $0`;pwd)
this_script=$(basename $0)
configDir=$this_dir/etc
configFile=$configDir/piLogger.conf

withAbioWire=""
piLoggerLocale=""

#=============================
# functions
#=============================
errorExit(){
  echo "ERROR: $@"
  exit 1
}

usage(){
cat<<EOT

Usage:

  $this_dir/$this_script [options]

Options:

  --withAbioWire  -> Using abio wire interface (will use Axiris port of owfs)
  --withLocale    -> Setting up en_US.UTF-8 locale

Default:

  * Default use of dpkg owfs

EOT

}

check(){

  echo "* Packages:"
  for package in owfs rrdtool lighttpd
  do
    echo -n "  - $package:"
    sudo dpkg -s $package >/dev/null 2>&1 && echo -n " OK! installed" || echo -n " ERROR: not installed"
    echo ""
  done
  
  echo "* Directories:"

  for dir in /var/piLogger /var/piLogger/db /var/piLogger/cache /var/piLogger/xml /var/piLogger/graphs 
  do
    echo -n "  - $dir:"
    [ -d $dir ] && echo -n " OK! exists" || echo -n " ERROR: does not exist"
    echo ""
  done

  echo "* Soft links:"

  for link in $this_dir/html/cache $this_dir/html/graphs $this_dir/html/xml /etc/piLogger.d
  do
    echo -n "  - $link:"
    [ -h $link ] && echo -n " OK! exists" || echo -n " ERROR: does not exist"
    echo ""
  done

  echo "* Crontab:"

  for crontabEntry in "bin/logAll" "bin/refreshCaches sensors" "bin/refreshCaches 12h" "bin/refreshCaches 24h" "bin/refreshCaches 168h"
  do
    echo -n "  - $crontabEntry:"
    crontab -l | grep "$crontabEntry" >/dev/null 2>&1 && echo -n " OK! exists" || echo -n " ERROR: does not exist"
    echo ""
  done
    
  echo "* Logrotate:"
  echo -n "  - file /etc/logrotate.d/piLogger:"
  [ -f /etc/logrotate.d/piLogger ] && echo -n " OK! exists" || echo -n " ERROR: does not exist"
  echo ""

  echo "* Config file entries:"

  echo -n "  - $configDir/piLogger.conf"
  [ -f $configDir/piLogger.conf ] && echo -n " OK! exists" || echo -n " does not exist"
  echo ""

  [ -f $configDir/piLogger.conf ] && {
    for parameter in interface piLoggerLocale baseDir htmlDir oneWireDir oneWireDataDir cacheDir temperatureFile
    do
      echo "  - $parameter="$(grep "^${parameter}=" $configDir/piLogger.conf | cut -d"=" -f2 )
    done

  }
  

}

#=============================
# Command line parameters
#=============================
while [ -n "$1" ]
do
  case $1 in
    --check)
        check
        exit 0
      ;;
    --withAbioWire)
      withAbioWire=true
      interface=AbioWire
      shift
      ;;
    --withLocale)
      withLocale=true
      piLoggerLocale=true
      shift
      ;;
    *)
      usage
      exit 1
      ;;
  esac
done


#=============================
# MAIN
#=============================

[ ! -d "$configDir" ] && mkdir -p $configDir

#--- prepare the config file

[ -f $configFile ] && errorExit "File $configFile already exists. Exiting! Please remove the config file before running again."

#--- set the interface

[ -z "$interface" ] && interface=default

cat>$configFile<<EOT
#----------------------------
# Config file for piLogger
#----------------------------
interface=$interface
piLoggerLocale=$piLoggerLocale

baseDir=$this_dir
htmlDir=$this_dir/html
oneWireDir=/mnt/1wire
oneWireDataDir=/var/piLogger
cacheDir=/var/piLogger/cache
temperatureFile=temperature

#----------------------
dateFormat="+%Y%m%d %H%M%S"
EOT
